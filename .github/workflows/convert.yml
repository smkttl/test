name: Extract RAR and Convert to ZIP

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'Filename (without .rar)'
        required: true
        type: string
      rar_password:
        description: 'RAR file password'
        required: true
        type: string

jobs:
  convert-archive:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download and install WinRAR CLI
      run: |
        $url = "https://www.rarlab.com/rar/winrar-x64-623.exe"
        $installer = "winrar.exe"
        Invoke-WebRequest -Uri $url -OutFile $installer
        Start-Process -FilePath $installer -ArgumentList "/s" -Wait
        $winrarPath = "C:\Program Files\WinRAR"
        echo "$winrarPath" | Out-File -FilePath $env:GITHUB_PATH -Append
      
    - name: Verify RAR file exists
      run: |
        $rarFile = "${{ github.event.inputs.filename }}.rar"
        if (-not (Test-Path $rarFile)) {
          Write-Error "RAR file not found: $rarFile"
          exit 1
        }
        Write-Host "Found RAR file: $((Get-Item $rarFile).Length) bytes"
      
    - name: Extract RAR with password
      run: |
        $rarFile = "${{ github.event.inputs.filename }}.rar"
        $extractPath = "${{ github.event.inputs.filename }}extracted"
        New-Item -ItemType Directory -Force -Path $extractPath
        rar x -p${{ github.event.inputs.rar_password }} "$rarFile" "$extractPath\"
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to extract RAR file. Check the password."
          exit 1
        }
      
    - name: Create ZIP archive
      run: |
        $extractPath = "${{ github.event.inputs.filename }}extracted"
        $zipFile = "${{ github.event.inputs.filename }}.zip"
        Compress-Archive -Path "$extractPath\*" -DestinationPath $zipFile -Force
        if (Test-Path $zipFile) {
          Write-Host "ZIP file created successfully: $zipFile"
          Write-Host "File size: $((Get-Item $zipFile).Length) bytes"
        } else {
          Write-Error "Failed to create ZIP file"
          exit 1
        }
      
    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: converted-zip
        path: ${{ github.event.inputs.filename }}.zip
        retention-days: 1

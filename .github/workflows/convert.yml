name: Extract RAR and Convert to ZIP

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'Filename (without .rar)'
        required: true
        type: string
      rar_password:
        description: 'RAR file password'
        required: true
        type: string

jobs:
  convert-archive:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download and install WinRAR CLI
      run: |
        $url = "https://www.rarlab.com/rar/winrar-x64-623.exe"
        $installer = "winrar.exe"
        Invoke-WebRequest -Uri $url -OutFile $installer
        Start-Process -FilePath $installer -ArgumentList "/s" -Wait
        $winrarPath = "C:\Program Files\WinRAR"
        echo "$winrarPath" | Out-File -FilePath $env:GITHUB_PATH -Append
      
    - name: Verify RAR file exists
      run: |
        $rarFile = "${{ github.event.inputs.filename }}.rar"
        if (-not (Test-Path $rarFile)) {
          Write-Error "RAR file not found: $rarFile"
          exit 1
        }
        Write-Host "Found RAR file: $((Get-Item $rarFile).Length) bytes"
      
    - name: Extract RAR with password
      shell: cmd
      run: |
        rar x -p"%password%" "%rar_file%" "%extract_path%\"
        if errorlevel 1 (
          echo Error: Failed to extract RAR file. Check the password or file integrity.
          exit /b 1
        )
        echo Successfully extracted RAR file
      env:
        rar_file: ${{ github.event.inputs.filename }}.rar
        password: ${{ github.event.inputs.rar_password }}
        extract_path: ${{ github.event.inputs.filename }}_extracted
      
    - name: Create ZIP archive
      run: |
        $extractPath = "${{ github.event.inputs.filename }}_extracted"
        $zipFile = "${{ github.event.inputs.filename }}.zip"
        Compress-Archive -Path "$extractPath\*" -DestinationPath $zipFile -Force
        if (Test-Path $zipFile) {
          Write-Host "ZIP file created successfully: $zipFile"
          Write-Host "File size: $((Get-Item $zipFile).Length) bytes"
        } else {
          Write-Error "Failed to create ZIP file"
          exit 1
        }
      
    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: converted-zip
        path: ${{ github.event.inputs.filename }}.zip
        retention-days: 1
